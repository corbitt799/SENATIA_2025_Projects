// This #include statement was automatically added by the Particle IDE.
#include <Adafruit_BME280.h>

// This #include statement was automatically added by the Particle IDE.
#include <Particle.h>
#include <Adafruit_BME280.h>
#include <Wire.h>

// Blynk and Webhook Constants
const char* BLYNK_TOKEN = "CCaHOMIumtu3MT9NL0ZM699XjUWZJq2O";
const char* EVENT_NAME = "blynk_https_get";   // Telemetry webhook
const char* ALERT_EVENT_NAME = "blynk_alert"; // Alert/notification webhook

// BME280 Setup
#define SEALEVELPRESSURE_HPA (1013.25)
Adafruit_BME280 bme; // I2C
bool bmeAvailable = false; // true if bme.begin() succeeded

// Relay Setup
#define RELAY_PIN D3
bool relayState = false;

// Tamper Switch Setup
// D4 is wired to VCC through the tamper switch.
// - Door CLOSED: switch closed -> D4 pulled HIGH
// - Door OPEN: switch open -> D4 pulled LOW (via pulldown resistor)
#define TAMPER_PIN D4
int tamperStableState = LOW;
int tamperLastRead = LOW;
unsigned long tamperLastDebounceTime = 0;
const unsigned long TAMPER_DEBOUNCE_DELAY = 50; // 50 ms debounce

// Timing
unsigned long lastUpdate = 0;
const unsigned long UPDATE_INTERVAL = 60000; // 1 minute in ms

void setRelayState(bool state);

void setup() {
    Serial.begin(9600);

    // Setup relay pin
    pinMode(RELAY_PIN, OUTPUT);
    digitalWrite(RELAY_PIN, LOW);
    relayState = false;

    // Setup tamper pin (active-high closed, active-low open)
    pinMode(TAMPER_PIN, INPUT_PULLDOWN);
    tamperStableState = digitalRead(TAMPER_PIN);
    tamperLastRead = tamperStableState;

    // Try to initialize BME280
    bmeAvailable = bme.begin(0x76); // Use 0x77 if your sensor is at that address
    if (!bmeAvailable) {
        Serial.println("Warning: Could not find a valid BME280 sensor. Publishing zeros until available.");
    } else {
        Serial.println("BME280 initialized successfully.");
    }

    // Particle Cloud API
    Particle.function("setRelay", setRelay);
    Particle.variable("relayState", relayState);
}

void loop() {
    int tamperReading = digitalRead(TAMPER_PIN);

    // Debounce logic
    if (tamperReading != tamperLastRead) {
        tamperLastDebounceTime = millis();
        tamperLastRead = tamperReading;
    }

    if ((millis() - tamperLastDebounceTime) > TAMPER_DEBOUNCE_DELAY) {
        if (tamperStableState != tamperReading) {
            tamperStableState = tamperReading;

            // Tamper state changed -- report immediately
            float tempF = 0.0, humidity = 0.0, pressure = 0.0;

            if (bmeAvailable) {
                float tempC = bme.readTemperature();
                tempF = tempC * 9.0 / 5.0 + 32.0;
                humidity = bme.readHumidity();
                pressure = bme.readPressure() / 100.0F;
            }

            String timestamp = Time.format(Time.now(), TIME_FORMAT_ISO8601_FULL);

            // v4: current status (HIGH = Closed, LOW = Open)
            const char* tamperStateStr =
                (tamperStableState == HIGH) ? "Closed" : "Open";

            // v5: tamper event message for transitions
            const char* tamperEventStr =
                (tamperStableState == HIGH) ? "Tamper: Door Closed" : "Tamper: Door Opened";

            // ----- Publish telemetry to Blynk via main webhook -----
            String data = String::format(
                "{\"token\":\"%s\",\"v0\":%.2f,\"v1\":%.2f,\"v2\":%.2f,"
                "\"v3\":%d,\"v4\":\"%s\",\"v5\":\"%s\",\"v6\":\"%s\"}",
                BLYNK_TOKEN, tempF, humidity, pressure,
                relayState ? 1 : 0,
                tamperStateStr,
                tamperEventStr,
                timestamp.c_str()
            );

            Particle.publish(EVENT_NAME, data, PRIVATE);

            // ----- Publish alert/notification via separate webhook -----
            // This is intended to hit Blynk's Events/Notifications API
            String alertData = String::format(
                "{\"token\":\"%s\",\"msg\":\"%s\",\"state\":\"%s\",\"time\":\"%s\"}",
                BLYNK_TOKEN,
                tamperEventStr,
                tamperStateStr,
                timestamp.c_str()
            );

            Particle.publish(ALERT_EVENT_NAME, alertData, PRIVATE);

            Serial.printlnf(
                "Tamper Transition! T: %.2fF H: %.2f%% P: %.2fhPa Relay: %d State: %s Event: %s",
                tempF, humidity, pressure, relayState, tamperStateStr, tamperEventStr
            );
        }
    }

    // Periodic updates (no new tamper event)
    if (millis() - lastUpdate >= UPDATE_INTERVAL) {
        lastUpdate = millis();

        // Retry BME init if needed
        if (!bmeAvailable) {
            if (bme.begin(0x76)) {
                bmeAvailable = true;
                Serial.println("BME280 initialized on retry.");
            } else {
                Serial.println("BME280 still not available; publishing zeros this interval.");
            }
        }

        float tempF = 0.0, humidity = 0.0, pressure = 0.0;

        if (bmeAvailable) {
            float tempC = bme.readTemperature();
            tempF = tempC * 9.0 / 5.0 + 32.0;
            humidity = bme.readHumidity();
            pressure = bme.readPressure() / 100.0F;
        }

        // v4: current door/tamper status (HIGH = Closed, LOW = Open)
        const char* tamperStateStr =
            (tamperStableState == HIGH) ? "Closed" : "Open";

        // v5: on regular heartbeat, no *new* tamper event
        const char* tamperEventStr = "None Detected";

        String timestamp = Time.format(Time.now(), TIME_FORMAT_ISO8601_FULL);

        String data = String::format(
            "{\"token\":\"%s\",\"v0\":%.2f,\"v1\":%.2f,\"v2\":%.2f,"
            "\"v3\":%d,\"v4\":\"%s\",\"v5\":\"%s\",\"v6\":\"%s\"}",
            BLYNK_TOKEN, tempF, humidity, pressure,
            relayState ? 1 : 0,
            tamperStateStr,
            tamperEventStr,
            timestamp.c_str()
        );

        Particle.publish(EVENT_NAME, data, PRIVATE);

        Serial.printlnf(
            "Periodic update: T: %.2fF H: %.2f%% P: %.2fhPa Relay: %d Tamper: %s Event: %s",
            tempF, humidity, pressure, relayState, tamperStateStr, tamperEventStr
        );
    }
}

// Particle.function to control relay remotely
int setRelay(String command) {
    if (command == "1") {
        setRelayState(true);
        return 1;
    } else if (command == "0") {
        setRelayState(false);
        return 0;
    }
    return -1;
}

void setRelayState(bool state) {
    relayState = state;
    digitalWrite(RELAY_PIN, relayState ? HIGH : LOW);
}
